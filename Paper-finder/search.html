<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Paper Finder (Scopus + PubMed + arXiv + Google Scholar + IEEE Xplore)</title>

  <!-- Optional: not required for ZIP because ZIP is built server-side.
       Keep only if you actually have jszip.min.js locally. -->
  <script src="jszip.min.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
    input, button, textarea { padding: 8px; font-size: 14px; }
    input[type="number"]{ width: 120px; }
    textarea { width: 100%; min-height: 70px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 10px 0; }
    .meta { opacity: 0.8; margin-top: 4px; }
    .links a { margin-right: 10px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ccc; border-radius:999px; font-size:12px; margin-left:8px; }
    .small { font-size: 12px; opacity: 0.85; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 12px 0; }
    .warn { border:1px solid #f2c200; background:#fff8db; padding:10px; border-radius:10px; }
    .error { border:1px solid #e11d48; background:#fff1f2; padding:10px; border-radius:10px; margin:10px 0; display:none; white-space: pre-wrap; }
    button:disabled { opacity: .55; cursor: not-allowed; }
  </style>
</head>

<body>
  <h2>Paper Finder</h2>
  <div class="small">
    PubMed + arXiv are fetched through a local proxy (this Flask app) so it works on office networks.
    Google Scholar, IEEE Xplore, and Scopus are link-only.
  </div>

  <div class="row" style="margin-top: 12px;">
    <div style="flex: 1; min-width: 280px;">
      <label>Query</label><br/>
      <input id="q" style="width: 100%;" value="graph learning functional connectivity"/>
    </div>
    <div>
      <label>Year from</label><br/>
      <input id="y1" type="number" value="2019"/>
    </div>
    <div>
      <label>Year to</label><br/>
      <input id="y2" type="number" value="2026"/>
    </div>
    <div>
      <label>Max / source</label><br/>
      <input id="max" type="number" value="25" min="1" />
    </div>
  </div>

  <div class="actions">
    <label><input id="src_scopus" type="checkbox" /> Scopus <span class="small">(link only)</span></label>
    <label><input id="src_pubmed" type="checkbox" checked/> PubMed</label>
    <label><input id="src_arxiv" type="checkbox" checked/> arXiv</label>
    <label><input id="src_scholar" type="checkbox" /> Google Scholar <span class="small">(link only)</span></label>
    <label><input id="src_ieee" type="checkbox" /> IEEE Xplore <span class="small">(link only)</span></label>

    <label><input id="oaOnly" type="checkbox"/> Open-access only </label>

    <button id="btnSearch">Search</button>
    <label><input id="selectAll" type="checkbox" /> Select all</label>

    <button id="btnExport" disabled>Export selected (CSV)</button>
    <button id="btnOpenPdfs" disabled>Open selected PDF links</button>
    <button id="btnZip" disabled>Download selected (ZIP)</button>

    <span id="status" class="small"></span>
  </div>

  <div class="warn small">
    <b>Notes</b>
    <ul style="margin:6px 0 0 18px;">
      <li><b>OA-only</b>: keeps only confirmed OA (arXiv). PubMed OA is unknown here → excluded when OA-only is checked.</li>
      <li><b>Scopus/Scholar/IEEE</b>: link-only cards (no parsing).</li>
    </ul>
  </div>

  <div id="errBox" class="error small"></div>

  <div style="margin-top: 10px;">
    <label>Optional prompt (used only for local keyword hinting; no LLM here)</label>
    <textarea id="prompt" placeholder="e.g., Prefer NeuroImage; include HCP; focus on methods/benchmarking"></textarea>
  </div>

  <hr/>
  <div id="results"></div>

<script>
  const $ = (id) => document.getElementById(id);

  function showError(msg){
    $("errBox").style.display = "block";
    $("errBox").textContent = msg;
  }
  function clearError(){
    $("errBox").style.display = "none";
    $("errBox").textContent = "";
  }
  function setStatus(msg){ $("status").textContent = msg; }

  function csvEscape(s){
    s = (s ?? "").toString();
    return `"${s.replaceAll('"','""')}"`;
  }
  function normalizeTitle(t){ return (t || "").replace(/\s+/g," ").trim(); }

  function getSelectedPapers(){
    const checks = document.querySelectorAll('input[data-paper-id]:checked');
    const ids = new Set([...checks].map(c => c.getAttribute('data-paper-id')));
    return (window.__papers || []).filter(p => ids.has(p.id));
  }

  function updateButtons(){
    const sel = getSelectedPapers();
    $("btnExport").disabled = sel.length === 0;
    $("btnOpenPdfs").disabled = sel.length === 0;
    $("btnZip").disabled = sel.length === 0;
  }

  async function searchPubMed(q, y1, y2, max){
    const url = `/api/pubmed?q=${encodeURIComponent(q)}&y1=${encodeURIComponent(y1||"")}&y2=${encodeURIComponent(y2||"")}&max=${encodeURIComponent(max)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error(`PubMed API failed HTTP ${r.status}`);
    return await r.json();
  }

  async function searchArxiv(q, y1, y2, max){
    const url = `/api/arxiv?q=${encodeURIComponent(q)}&y1=${encodeURIComponent(y1||"")}&y2=${encodeURIComponent(y2||"")}&max=${encodeURIComponent(max)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error(`arXiv API failed HTTP ${r.status}`);
    return await r.json();
  }

  function buildGoogleScholarLink(q, y1, y2){
    const params = new URLSearchParams();
    params.set("q", q);
    if (y1) params.set("as_ylo", String(y1));
    if (y2) params.set("as_yhi", String(y2));
    return `https://scholar.google.com/scholar?${params.toString()}`;
  }
  function buildIeeeXploreLink(q){
    const params = new URLSearchParams();
    params.set("querytext", q);
    return `https://ieeexplore.ieee.org/search/searchresult.jsp?${params.toString()}`;
  }
  function buildScopusLink(q){
    const scopusQuery = `TITLE-ABS-KEY(${q})`;
    const params = new URLSearchParams();
    params.set("query", scopusQuery);
    return `https://www.scopus.com/results/results.uri?${params.toString()}`;
  }

  function linkOnlyCard(source, landing_url, q, y1, y2){
    return [{
      id: `${source}:${landing_url}`,
      title: `${source} search (opens in new tab)`,
      authors: [],
      year: null,
      venue: source,
      source,
      oa: null,
      pdf_url: null,
      landing_url,
      doi: null,
      note: `Link-only: open the Search link. Query="${q}" Years=${y1||"—"}-${y2||"—"}.`
    }];
  }

  function setAllSelected(checked){
    const root = $("results");
    const boxes = root.querySelectorAll('input[data-paper-id]');
    boxes.forEach(b => { b.checked = checked; });
    updateButtons();
    updateSelectAllState();
  }

  function updateSelectAllState(){
    const root = $("results");
    const boxes = [...root.querySelectorAll('input[data-paper-id]')];
    const selAll = $("selectAll");

    if (!boxes.length){
      selAll.checked = false;
      selAll.indeterminate = false;
      selAll.disabled = true;
      return;
    }
    selAll.disabled = false;

    const checkedCount = boxes.filter(b => b.checked).length;
    selAll.checked = checkedCount === boxes.length;
    selAll.indeterminate = checkedCount > 0 && checkedCount < boxes.length;
  }

  $("selectAll").addEventListener("change", (e) => {
    setAllSelected(e.target.checked);
  });

  function selectedToCsv(selected){
    const headers = ["title","authors","year","venue","doi","source","oa","pdf_url","landing_url","note"];
    const rows = selected.map(p => ([
      p.title,
      (p.authors || []).join("; "),
      p.year ?? "",
      p.venue ?? "",
      p.doi ?? "",
      p.source,
      (p.oa === true) ? "true" : (p.oa === false ? "false" : ""),
      p.pdf_url ?? "",
      p.landing_url ?? "",
      p.note ?? ""
    ]));
    return [headers.join(","), ...rows.map(r => r.map(csvEscape).join(","))].join("\n");
  }

  function downloadBlob(blob, filename){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function render(papers){
    window.__papers = papers;
    const root = $("results");
    root.innerHTML = "";

    if (!papers.length){
      root.innerHTML = `<div class="small">No results.</div>`;
      updateButtons();
      updateSelectAllState();
      return;
    }

    for (const p of papers){
      const div = document.createElement("div");
      div.className = "card";

      const authors = (p.authors || []).slice(0,10).join(", ") + ((p.authors||[]).length > 10 ? "…" : "");
      const pdfLink = p.pdf_url ? `<a href="${p.pdf_url}" target="_blank" rel="noreferrer">PDF</a>` : "";
      const landingText = (p.source === "Google Scholar" || p.source === "IEEE Xplore" || p.source === "Scopus") ? "Search" : "Landing";
      const landing = p.landing_url ? `<a href="${p.landing_url}" target="_blank" rel="noreferrer">${landingText}</a>` : "";

      let oaPill = `<span class="pill">OA?</span>`;
      if (p.oa === true) oaPill = `<span class="pill">OA</span>`;
      if (p.oa === false) oaPill = `<span class="pill">Not OA</span>`;

      const note = p.note ? `<div class="small" style="margin-top:8px;">${p.note}</div>` : "";

      div.innerHTML = `
        <label style="display:flex; gap:10px;">
          <input type="checkbox" data-paper-id="${p.id}" />
          <div style="flex:1;">
            <div style="font-weight:700;">${normalizeTitle(p.title)} ${oaPill}</div>
            <div class="meta">${authors || ""}</div>
            <div class="meta">${p.year ?? "—"} · ${p.venue ?? "—"} · ${p.source}</div>
            <div class="links" style="margin-top:8px;">${landing} ${pdfLink}</div>
            ${note}
          </div>
        </label>
      `;
      root.appendChild(div);
    }

    root.querySelectorAll('input[data-paper-id]').forEach(cb => {
      cb.addEventListener("change", () => {
        updateButtons();
        updateSelectAllState();
      });
    });

    updateButtons();
    updateSelectAllState();
  }

  // ---------------- Button handlers ----------------

  $("btnSearch").addEventListener("click", async () => {
    clearError();

    const q  = $("q").value.trim();
    const y1 = Number($("y1").value) || null;
    const y2 = Number($("y2").value) || null;
    const max = Math.max(1, Number($("max").value) || 25);

    const oaOnly     = $("oaOnly").checked;
    const useScopus  = $("src_scopus").checked;
    const usePubMed  = $("src_pubmed").checked;
    const useArxiv   = $("src_arxiv").checked;
    const useScholar = $("src_scholar").checked;
    const useIeee    = $("src_ieee").checked;

    if (!q){
      showError("Please enter a search query.");
      return;
    }

    setStatus("Searching...");
    render([]); // clear old results
    updateButtons();
    $("selectAll").checked = false;
    $("selectAll").indeterminate = false;

    try{
      let all = [];

      if (usePubMed){
        setStatus("Searching PubMed...");
        all = all.concat(await searchPubMed(q, y1, y2, max));
      }

      if (useArxiv){
        setStatus("Searching arXiv...");
        all = all.concat(await searchArxiv(q, y1, y2, max));
      }

      if (oaOnly){
        all = all.filter(p => p.oa === true);
      }

      if (useScholar){
        all = all.concat(linkOnlyCard("Google Scholar", buildGoogleScholarLink(q, y1, y2), q, y1, y2));
      }
      if (useIeee){
        all = all.concat(linkOnlyCard("IEEE Xplore", buildIeeeXploreLink(q), q, y1, y2));
      }
      if (useScopus){
        all = all.concat(linkOnlyCard("Scopus", buildScopusLink(q), q, y1, y2));
      }

      all.sort((a,b) => (b.year || 0) - (a.year || 0));
      render(all);
      setStatus(`Done. Results: ${all.length}`);
    } catch (e){
      console.error(e);
      showError(`Fetch failed: ${String(e?.message || e)}`);
      setStatus("Error.");
      render([]);
    }
  });

  $("btnExport").addEventListener("click", () => {
    const sel = getSelectedPapers();
    if (!sel.length) return;
    downloadBlob(new Blob([selectedToCsv(sel)], {type:"text/csv"}), "selected_papers.csv");
  });

  $("btnOpenPdfs").addEventListener("click", () => {
    const sel = getSelectedPapers();
    const links = sel.map(p => p.pdf_url).filter(Boolean);
    if (!links.length){
      alert("No PDF links available in your selection (mostly arXiv provides direct PDFs).");
      return;
    }
    links.forEach(l => window.open(l, "_blank"));
  });

  $("btnZip").addEventListener("click", async () => {
    const sel = getSelectedPapers();
    if (!sel.length) return;

    $("btnZip").disabled = true;
    clearError();
    setStatus("Building ZIP...");

    try{
      const r = await fetch("/api/zip", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(sel)
      });

      if (!r.ok){
        throw new Error(`ZIP failed HTTP ${r.status}`);
      }

      const blob = await r.blob();
      downloadBlob(blob, "selected_papers.zip");
      setStatus(`ZIP downloaded. Selected: ${sel.length}`);
    } catch (e){
      console.error(e);
      showError(`ZIP failed: ${String(e?.message || e)}`);
      setStatus("Error.");
    }

    updateButtons();
  });

</script>
</body>
</html>
